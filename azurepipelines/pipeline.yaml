trigger:
- main

resources:
- repo: self

variables:
  dockerfilePath: '$(Build.SourcesDirectory)/Dockerfile'
  tag: '$(Build.BuildId)'
  repo: "projektzespolowy"

stages:
- stage: Terraform
  jobs:
  - job: TerraformJob
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - script: |
        terraform init
        terraform plan -out=tfplan
        terraform apply -auto-approve tfplan
      displayName: 'Terraform init, plan and apply'
      workingDirectory: Terraform

    - task: PowerShell@2
      displayName: 'Set Terraform Outputs as Pipeline Variables'
      name: TfOutput
      inputs:
        workingDirectory: Terraform
        targetType: 'inline'
        script: |
          $outputs = terraform output -json | ConvertFrom-Json
          foreach ($key in $outputs.PSObject.Properties.Name) {
            $value = $outputs.$key.value
            $sanitizedKey = $key -replace '\.', '_'
            Write-Host $sanitizedKey
            Write-Host $value
            Write-Host "##vso[task.setvariable variable=$sanitizedKey]$value"
            echo "published variable $sanitizedKey"
          }
          $IsFooEqualToBar = "true"
          Write-Host "##vso[task.setvariable variable=IsFooBar]$IsFooEqualToBar"
        pwsh: true

    - pwsh: Write-Host $(container_registry_name)

  - job: BuildAdnDeploy
    variables:
      container_registry_name: $[ dependencies.TerraformJon.outputs['TfOutput.container_registry_name'] ]
    dependsOn: TerraformJob
    steps:
    - task: AzureCLI@2
      displayName: Login to ACR
      inputs:
        azureSubscription: ProjektZespolowySC
        scriptType: 'pscore'
        scriptLocation: 'inlineScript'
        inlineScript: |
          Write-Host "test"
          Write-Host "$(container_registry_name)"
          Write-Host "test"
          az acr login $(container_registry_name)

    - task: Docker@2
      inputs:
        repository: $(container_registry_login_server)/$(repo)
        command: 'buildAndPush'
        Dockerfile: $(dockerfilePath)
        tags: |
          $(tag)

    - task: AzureCLI@2
      inputs:
        azureSubscription: ProjektZespolowySC
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          az aks get-credentials --resource-group <TwojaGrupaZasobow> --name <TwojeAKSClusterName>
          kubectl set image deployment/<deploymentName> <containerName>=$(containerRegistry)/$(imageRepository):$(tag)
